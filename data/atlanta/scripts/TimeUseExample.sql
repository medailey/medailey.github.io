
/* Time Use Data for ABMVIZ HTML5 */
/* Ben Stabler, ben.stabler@rsginc.com, 07/08/16 */

/* Set Scenario  */
ALTER USER [ATLANTAREGION\TAMConsult] WITH DEFAULT_SCHEMA = BS10

/* Creates the TIMEUSE table.  This query only needs to be run once per scenario */
IF EXISTS (SELECT * FROM sys.objects WHERE name = 'TIMEUSE')
	BEGIN
		DROP TABLE TIMEUSE
	END
			
DECLARE @minPERIOD AS INT
DECLARE @maxPERIOD AS INT
DECLARE @hr AS INT

SET @minPERIOD = 1
SET @maxPERIOD = 48

CREATE TABLE TIMEUSE (PERSON_TYPE VARCHAR(50), PER INT, ORIG_PURPOSE VARCHAR(50), QUANTITY INT)
CREATE TABLE TIMEUSE_TEMP (PERSON_TYPE VARCHAR(50), PER INT, ORIG_PURPOSE VARCHAR(50), QUANTITY INT)

/* Create Remainder of the day at home table */
CREATE TABLE REMAINDER (PERSON_TYPE VARCHAR(50), PER INT, QUANTITY INT)
INSERT INTO REMAINDER SELECT PERSON_TYPE, PER, COUNT(*) AS QUANTITY
	FROM (SELECT PERSON_TYPE, MAX(DEPART_PERIOD) AS PER FROM TRIPS GROUP BY PERSON_ID, PERSON_TYPE) AS TEMP
	GROUP BY PERSON_TYPE, PER

/* Loop by PERIOD and add to DayPop table */
SET @hr = @minPERIOD
WHILE @hr <= @maxPERIOD 
	BEGIN

		/* Person by PERIOD of the day based on trips */
		INSERT INTO TIMEUSE_TEMP (PERSON_TYPE, PER, ORIG_PURPOSE, QUANTITY) SELECT PERSON_TYPE, @hr AS PER, ORIG_PURPOSE, COUNT(*) AS QUANTITY
		FROM TRIPS
		WHERE ORIG_PURPOSE_START_PERIOD < (@hr+1) AND DEPART_PERIOD > (@hr-1)
		GROUP BY PERSON_TYPE, ORIG_PURPOSE

		/* Remainder of the day at home after trip making */
		INSERT INTO TIMEUSE_TEMP (PERSON_TYPE, PER, ORIG_PURPOSE, QUANTITY) SELECT PERSON_TYPE, @hr AS PER, 'Home', QUANTITY
		FROM REMAINDER
		WHERE PER < @hr

		/* Persons that stay home all day */
		INSERT INTO TIMEUSE_TEMP (PERSON_TYPE, PER, ORIG_PURPOSE, QUANTITY) SELECT PERSON_TYPE, @hr AS PER, 'Home', COUNT(*) AS QUANTITY
		FROM PERSONDATA, HHDATA
		WHERE PERSONDATA.ACTIVITY_PATTERN='H' AND PERSONDATA.HH_ID = HHDATA.HH_ID
		GROUP BY PERSON_TYPE

	  SET @hr = @hr + 1

	END

DROP TABLE REMAINDER

INSERT INTO TIMEUSE SELECT PERSON_TYPE, PER, ORIG_PURPOSE, SUM(QUANTITY) AS QUANTITY
	FROM TIMEUSE_TEMP
	GROUP BY PERSON_TYPE, PER, ORIG_PURPOSE
	ORDER BY PERSON_TYPE, PER, ORIG_PURPOSE

DROP TABLE TIMEUSE_TEMP

/* Change some purpose labels */
UPDATE TIMEUSE SET ORIG_PURPOSE = REPLACE(ORIG_PURPOSE, 'atwork', 'work sub-tour')
UPDATE TIMEUSE SET ORIG_PURPOSE = REPLACE(ORIG_PURPOSE, 'othmaint', 'other maintenance')
UPDATE TIMEUSE SET ORIG_PURPOSE = REPLACE(ORIG_PURPOSE, 'othdiscr', 'other discretionary')

/* Select all records from the TIMEUSE table twice (by person type and for all persons at once) 
and return PERSON_TYPE, PER (period), ORIG_PURPOSE, and QUANTITY to populate the Time Use visual */
SELECT UPPER(PERSON_TYPE) AS PERSON_TYPE, PER, UPPER(ORIG_PURPOSE) AS ORIG_PURPOSE, QUANTITY
FROM TIMEUSE
UNION
SELECT 'ALL' AS PERSON_TYPE, PER, UPPER(ORIG_PURPOSE) AS ORIG_PURPOSE, SUM(QUANTITY) AS QUANTITY
FROM TIMEUSE
GROUP BY PER, ORIG_PURPOSE

