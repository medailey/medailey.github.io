
/* 3D Animated Map Example Query for ABMVIZ HTML5 */
/* Ben Stabler, ben.stabler@rsginc.com, 07/08/16 */

/* Set Scenario  */
ALTER USER [ATLANTAREGION\TAMConsult] WITH DEFAULT_SCHEMA = BS10

/* Create daytime population table (Persons by TAZ by PERIOD of the day)
  This query only needs to be run once per scenario */
IF EXISTS (SELECT * FROM sys.objects WHERE name = 'DAYPOP')
	BEGIN
		DROP TABLE DAYPOP
	END

DECLARE @minPERIOD AS INT
DECLARE @maxPERIOD AS INT
DECLARE @hr AS INT
DECLARE @hrStr AS VARCHAR(6)

SET @minPERIOD = 1
SET @maxPERIOD = 48

CREATE TABLE DAYPOP (TAZ INT, PER VARCHAR(6), PERSONS INT, PERSONSNOTATHOME INT)
CREATE TABLE DAYPOP_TEMP (TAZ INT, PER VARCHAR(6), PERSONS INT, PERSONSNOTATHOME INT)

/* Create Remainder of the day at home table */
CREATE TABLE REMAINDER (TAZ INT, PER INT, QUANTITY INT)
INSERT INTO REMAINDER SELECT TAZ, PER, COUNT(*) AS QUANTITY
	FROM (SELECT MIN(HOME_TAZ) AS TAZ, MAX(DEPART_PERIOD) AS PER FROM TRIPS GROUP BY PERSON_ID) AS TEMP
	GROUP BY TAZ, PER

/* Loop by PERIOD and add to DayPop table */
SET @hr = @minPERIOD
WHILE @hr <= @maxPERIOD 
	BEGIN

		/* Prepare string version of PER for easier sorting */
		SET @hrStr = 'PER' + CAST(@hr AS VARCHAR(6))
		IF @hr < 10
			BEGIN
			SET @hrStr = 'PER0' + CAST(@hr AS VARCHAR(6))
			END

		/* Person location by PERIOD of the day based on trips */
		INSERT INTO DAYPOP_TEMP (TAZ, PER, PERSONS) SELECT ORIG_TAZ, @hrStr AS PER, COUNT(*) AS PERSONS
		FROM TRIPS
		WHERE ORIG_PURPOSE_START_PERIOD < (@hr+1) AND DEPART_PERIOD > (@hr-1)
		GROUP BY ORIG_TAZ
		
		/* Remainder of the day at home after trip making */
		INSERT INTO DAYPOP_TEMP (TAZ, PER, PERSONS) SELECT TAZ, @hrStr AS PER, QUANTITY
		FROM REMAINDER
		WHERE PER < @hr
		
		/* Persons that stay home all day - add to each PERIOD for taz */
		INSERT INTO DAYPOP_TEMP (TAZ, PER, PERSONS) SELECT TAZ, @hrStr AS PER, COUNT(*) AS PERSONS
		FROM PERSONDATA, HHDATA
		WHERE PERSONDATA.ACTIVITY_PATTERN='H' AND PERSONDATA.HH_ID = HHDATA.HH_ID
		GROUP BY TAZ
		
		/* Person location NOT AT HOME by PERIOD of the day based on trips */
		INSERT INTO DAYPOP_TEMP (TAZ, PER, PERSONSNOTATHOME) SELECT ORIG_TAZ, @hrStr AS PER, COUNT(*) AS PERSONSNOTATHOME
		FROM TRIPS
		WHERE ORIG_PURPOSE_START_PERIOD < (@hr+1) AND DEPART_PERIOD > (@hr-1) AND ORIG_PURPOSE !='Home'
		GROUP BY ORIG_TAZ
		
	  SET @hr = @hr + 1
	END

DROP TABLE REMAINDER

INSERT INTO DAYPOP SELECT TAZ, PER, SUM(PERSONS) AS PERSONS, SUM(PERSONSNOTATHOME) AS PERSONSNOTATHOME
	FROM DAYPOP_TEMP
	GROUP BY TAZ, PER
	ORDER BY TAZ, PER

DROP TABLE DAYPOP_TEMP

/* Select daytime population records for persons not at home from the DAYPOP table */
SELECT TAZ AS ZONE, PER, PERSONSNOTATHOME AS QUANTITY
FROM DAYPOP
ORDER BY TAZ, PER
